<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Collaboration Detail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script type="module" src="https://rw-501.github.io/contenthub/js/firebase-config.js" defer></script>
  <link rel="stylesheet" href="https://rw-501.github.io/contenthub/css/main.css" />
  <style>
    #chatBox { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fff; }
    #chatBox .msg { margin-bottom: 10px; }
    .task { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .edit-btn { cursor: pointer; color: blue; font-size: 0.9rem; }
  </style>
</head>
<body>
    
      <div id="toolbarContainer"></div>

  <!-- Your page content here -->

  <!-- Include Bootstrap JS (required for navbar) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inject toolbar -->
  <script type="module">
    const toolbarContainer = document.getElementById("toolbarContainer");
    const html = await fetch('https://rw-501.github.io/contenthub/includes/nav.html').then(res => res.text());
    toolbarContainer.innerHTML = html;
    import('https://rw-501.github.io/contenthub/includes/nav.js');
  </script>

  <main id="main">
    <div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 id="collabTitle">Loading...</h2>
    <span id="editControls" class="d-none">
      <button class="btn btn-sm btn-outline-secondary" id="editCollab">‚úèÔ∏è Edit</button>
    </span>
  </div>
  <p id="collabDesc" class="text-muted"></p>

  <!-- Media Preview -->
  <div id="mediaPreview" class="mb-3"></div>

  <!-- Visibility Toggle -->
  <div class="form-check form-switch mb-4">
    <input class="form-check-input" type="checkbox" id="publicToggle" />
    <label class="form-check-label" for="publicToggle">Visible in Collab Zone</label>
  </div>

  <!-- Chat Section -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üí¨ Chat <small id="typingStatus" class="text-muted"></small></h5>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#chatSection">Toggle</button>
    </div>
    <div class="collapse show" id="chatSection">
      <div class="card-body">
        <div id="chatBox" class="mb-3" style="max-height: 300px; overflow-y: auto;"></div>
        <div class="input-group">
          <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." />
          <button class="btn btn-outline-primary" id="sendChat">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shared Board -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üìå Shared Board</h5>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#taskBoard">Toggle</button>
    </div>
    <div class="collapse show" id="taskBoard">
      <div class="card-body">

        <!-- Progress Bar -->
        <div class="progress mb-3" id="taskProgressBar" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar" id="progressBarFill" style="width: 0%;"></div>
        </div>

        <!-- Filters -->
        <div class="mb-3 d-flex flex-wrap gap-2">
          <select id="filterGoal" class="form-select w-auto">
            <option value="">All Goals</option>
          </select>
          <select id="filterAssignee" class="form-select w-auto">
            <option value="">All Assignees</option>
          </select>
        </div>

        <!-- Task List -->
        <div id="taskList" class="mb-4"></div>

        <!-- Task Form -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">‚ûï Add New Task</h6>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#taskForm">Toggle</button>
          </div>
          <div class="collapse show" id="taskForm">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <input type="text" id="newTask" class="form-control" placeholder="Task or link..." />
                </div>
                <div class="col-md-3">
                  <input type="text" id="taskGoal" class="form-control" placeholder="Goal or category" />
                </div>
                <div class="col-md-2">
                  <input type="number" id="taskOrder" class="form-control" placeholder="Order" min="1" />
                </div>
                <div class="col-md-3">
                  <input type="date" id="taskDeadline" class="form-control" />
                </div>
                <div class="col-md-4">
                  <input type="text" id="taskAssignee" class="form-control" placeholder="Assign to user ID" />
                </div>
                <div class="col-md-5">
                  <input type="text" id="taskLinks" class="form-control" placeholder="Links (comma-separated)" />
                </div>
                <div class="col-md-3 d-grid">
                  <button class="btn btn-success" id="addTask">Add Task</button>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- End Task Form -->
      </div>
    </div>
  </div>

</div>

  </main>
  <div id="footerContainer"></div>
  <script type="module">
    import { getFirestore, doc, getDoc, updateDoc,docSnap, onSnapshot, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { db, auth } from 'https://rw-501.github.io/contenthub/js/firebase-config.js';

    
    const urlParams = new URLSearchParams(window.location.search);
const collabId = urlParams.get("id");

console.log("Full URL:", window.location.href);
console.log("Search Params:", window.location.search);
console.log("Collab ID:", collabId);

    const titleEl = document.getElementById("collabTitle");
    const descEl = document.getElementById("collabDesc");
    const mediaPreview = document.getElementById("mediaPreview");
    const publicToggle = document.getElementById("publicToggle");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const sendChat = document.getElementById("sendChat");
    const taskList = document.getElementById("taskList");
    const newTask = document.getElementById("newTask");
    const addTask = document.getElementById("addTask");
    const editControls = document.getElementById("editControls");
    const typingStatus = document.getElementById("typingStatus");

    let currentUser = null;
    let typingTimeout;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadCollab();
      }
    });

    function sanitize(text) {
      return text
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')
        .replace(/@([\w]+)/g, '<span class="text-primary">@$1</span>');
    }

    async function loadCollab() {
      const collabRef = doc(db, "collaborations", collabId);
      const snap = await getDoc(collabRef);
      if (!snap.exists()) return alert("Collaboration not found");

      const data = snap.data();
      const isParticipant = data.participants.includes(currentUser.uid);
      if (!isParticipant) return alert("Access denied");


      const tasksArray = docSnap.data().tasks || [];
      renderAllTasks(tasksArray);

      titleEl.innerText = data.title || "Untitled";
      descEl.innerText = data.description || "No description provided.";
      if (data.mediaLinks) {
        mediaPreview.innerHTML = data.mediaLinks.map(link => link.includes(".mp4") ? `<video src="${link}" controls class="w-100 mb-2"></video>` : `<img src="${link}" class="img-fluid mb-2"/>`).join("");
      }

      publicToggle.checked = !!data.isPublic;
      publicToggle.onchange = () => updateDoc(collabRef, { isPublic: publicToggle.checked });

      if (data.owner === currentUser.uid) editControls.classList.remove("d-none");

      onSnapshot(doc(db, "messages", collabId), docSnap => {
        chatBox.innerHTML = "";
        if (docSnap.data()?.messages) {
          docSnap.data().messages.forEach(msg => {
            const content = sanitize(msg.content);
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : "";
            chatBox.innerHTML += `<div class="msg" data-id="${msg.id}">
  <strong>${msg.sender}</strong>
  <small class="text-muted">${time}</small>: ${content}
  <span class="like-btn text-danger ms-2" style="cursor:pointer;">‚ù§Ô∏è ${msg.likes || 0}</span>
</div>
`;
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });

chatBox.querySelectorAll(".like-btn").forEach(btn => {
  btn.onclick = async () => {
    const msgId = btn.closest(".msg").dataset.id;
    const docSnap = await getDoc(threadRef);
    const updated = docSnap.data().messages.map(m =>
      m.id === msgId ? { ...m, likes: (m.likes || 0) + 1 } : m
    );
    await updateDoc(threadRef, { messages: updated });
  };
});

      chatInput.addEventListener("input", () => {
        clearTimeout(typingTimeout);
        typingStatus.innerText = "typing...";
        typingTimeout = setTimeout(() => typingStatus.innerText = "", 1000);
      });

      sendChat.onclick = async () => {
        const content = chatInput.value.trim();
        if (!content) return;
        const threadRef = doc(db, "messages", collabId);
        await updateDoc(threadRef, {
          messages: arrayUnion({ sender: currentUser.displayName || currentUser.email, content, timestamp: Date.now() })
        });
        chatInput.value = "";
      };

      if (data.tasks?.length) {
        taskList.innerHTML = data.tasks.map(t => `<div class="task"><span>${sanitize(t)}</span></div>`).join("");
      }

let draggedTaskId = null;

const pinBtn = document.createElement("button");
pinBtn.textContent = "üìå Pin";
pinBtn.className = "btn btn-sm btn-outline-warning";
pinBtn.onclick = async () => {
  const pinnedTasks = (data.pinnedTasks || []);
  if (!pinnedTasks.includes(taskObj.text)) {
    await updateDoc(collabRef, { pinnedTasks: arrayUnion(taskObj.text) });
  }
};

function renderPinnedTasks(pinnedTexts, tasks) {
  const pinnedSection = document.createElement("div");
  pinnedSection.innerHTML = "<h6>üìå Pinned Tasks</h6>";
  pinnedTexts.forEach(text => {
    const task = tasks.find(t => t.text === text);
    if (task) pinnedSection.appendChild(renderTask(task, true));
  });
  taskList.prepend(pinnedSection);
}

function updateProgressBar(tasks) {
  const total = tasks.length;
  const done = tasks.filter(t => t.completed).length;
  const percent = total ? Math.round((done / total) * 100) : 0;
  document.getElementById("progressBarFill").style.width = `${percent}%`;
  document.getElementById("progressBarFill").textContent = `${percent}% Complete`;
}

function renderAllTasks(tasksArray) {
  const taskList = document.getElementById("taskList");
  taskList.innerHTML = ""; // Clear first

  const sorted = tasksArray.sort((a, b) => (a.order || 0) - (b.order || 0));

  // Fetch pinned task texts from Firestore (you can pass this in if already loaded)
  getDoc(collabRef).then(docSnap => {
    const pinnedTexts = docSnap.data().pinnedTasks || [];

    // Render pinned tasks first
    if (pinnedTexts.length > 0) {
      renderPinnedTasks(pinnedTexts, sorted);
    }

    // Render the rest of the tasks (excluding pinned ones if you want)
    sorted.forEach(task => {
      if (!pinnedTexts.includes(task.text)) {
        renderTask(task);
      }
    });

    // Update progress bar
    updateProgressBar(sorted);
  });
}


function renderTask(taskObj) {
  const taskList = document.getElementById("taskList");

  const taskDiv = document.createElement("div");
  taskDiv.className = "task border rounded p-3 mb-2 bg-white shadow-sm";
  taskDiv.draggable = true;
  taskDiv.dataset.id = taskObj.text;

  taskDiv.ondragstart = () => draggedTaskId = taskObj.text;
  taskDiv.ondragover = e => e.preventDefault();
  taskDiv.ondrop = async () => {
    if (draggedTaskId !== taskObj.text) {
      const docSnap = await getDoc(collabRef);
      const tasks = docSnap.data().tasks || [];
      const draggedTask = tasks.find(t => t.text === draggedTaskId);
      const dropTask = tasks.find(t => t.text === taskObj.text);
      if (draggedTask && dropTask) {
        const temp = draggedTask.order;
        draggedTask.order = dropTask.order;
        dropTask.order = temp;
        await updateDoc(collabRef, { tasks });
        renderAllTasks(tasks);
      }
    }
  };

  const taskHeader = document.createElement("div");
  taskHeader.className = "d-flex justify-content-between align-items-center mb-2";

  const taskText = document.createElement("span");
  taskText.textContent = taskObj.text;
  taskText.className = taskObj.completed ? "text-decoration-line-through" : "";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.className = "form-check-input";
  checkbox.checked = taskObj.completed || false;
  checkbox.addEventListener("change", async () => {
    const updatedTask = { ...taskObj, completed: checkbox.checked };
    const docSnap = await getDoc(collabRef);
    const data = docSnap.data();
    const tasks = (data.tasks || []).filter(t => t.text !== taskObj.text);
    tasks.push(updatedTask);
    await updateDoc(collabRef, { tasks });
    taskText.classList.toggle("text-decoration-line-through");
  });

  taskHeader.append(taskText, checkbox);
  taskDiv.appendChild(taskHeader);

  const metaRow = document.createElement("div");
  metaRow.className = "small text-muted d-flex flex-wrap gap-3";

  if (taskObj.goal) metaRow.innerHTML += `<span>üéØ <strong>Goal:</strong> ${taskObj.goal}</span>`;
  if (taskObj.order !== null && taskObj.order !== undefined) metaRow.innerHTML += `<span>üî¢ <strong>Order:</strong> ${taskObj.order}</span>`;
  if (taskObj.deadline) {
    const dueDate = new Date(taskObj.deadline);
    const friendlyDate = dueDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    const isOverdue = Date.now() > dueDate.getTime();
    const deadlineClass = isOverdue ? "text-danger fw-bold" : "";
    metaRow.innerHTML += `<span class="${deadlineClass}">üïí <strong>Due:</strong> ${friendlyDate}</span>`;
  }
  if (taskObj.assignee) metaRow.innerHTML += `<span>üë§ <strong>Assigned:</strong> ${taskObj.assignee}</span>`;
  if (taskObj.links?.length) metaRow.innerHTML += `<span>üìé <strong>Links:</strong> ${taskObj.links.join(", ")}</span>`;

  taskDiv.appendChild(metaRow);

  const checklist = document.createElement("ul");
  (taskObj.checklist || []).forEach(item => {
    const li = document.createElement("li");
    li.textContent = item;
    checklist.appendChild(li);
  });
  taskDiv.appendChild(checklist);

  const commentBox = document.createElement("textarea");
  commentBox.className = "form-control form-control-sm mt-2";
  commentBox.placeholder = "Add comment...";
  commentBox.value = taskObj.comment || "";
  commentBox.addEventListener("blur", async () => {
    const docSnap = await getDoc(collabRef);
    const data = docSnap.data();
    const tasks = data.tasks.map(t => t.text === taskObj.text ? { ...t, comment: commentBox.value } : t);
    await updateDoc(collabRef, { tasks });
  });
  taskDiv.appendChild(commentBox);

  const btnGroup = document.createElement("div");
  btnGroup.className = "mt-2 d-flex gap-2";

  const editBtn = document.createElement("button");
  editBtn.className = "btn btn-sm btn-outline-primary";
  editBtn.textContent = "Edit";
  editBtn.onclick = () => {
    document.getElementById("newTask").value = taskObj.text;
    document.getElementById("taskGoal").value = taskObj.goal;
    document.getElementById("taskOrder").value = taskObj.order;
    document.getElementById("taskDeadline").value = taskObj.deadline;
    document.getElementById("taskAssignee").value = taskObj.assignee || "";
    document.getElementById("taskLinks").value = (taskObj.links || []).join(", ");
    deleteTask(taskObj.text);
  };

  const delBtn = document.createElement("button");
  delBtn.className = "btn btn-sm btn-outline-danger";
  delBtn.textContent = "Delete";
  delBtn.onclick = () => deleteTask(taskObj.text);

  btnGroup.append(editBtn, delBtn);
  taskDiv.appendChild(btnGroup);

  taskList.appendChild(taskDiv);
}

async function deleteTask(taskText) {
  const docSnap = await getDoc(collabRef);
  const tasks = (docSnap.data().tasks || []).filter(t => t.text !== taskText);
  await updateDoc(collabRef, { tasks });
  renderAllTasks(tasks);
}

addTask.onclick = async () => {
  const taskText = document.getElementById("newTask").value.trim();
  const goal = document.getElementById("taskGoal").value.trim();
  const order = parseInt(document.getElementById("taskOrder").value);
  const deadline = document.getElementById("taskDeadline").value;
  const assignee = document.getElementById("taskAssignee").value.trim();
  const links = document.getElementById("taskLinks").value.split(",").map(l => l.trim()).filter(Boolean);

  if (!taskText) return;

  const taskObj = {
    text: taskText,
    goal: goal || "General",
    order: isNaN(order) ? null : order,
    deadline: deadline || null,
    timestamp: Date.now(),
    completed: false,
    createdBy: currentUser.uid,
    checklist: [],
    links,
    assignee
  };

  await updateDoc(collabRef, {
    tasks: arrayUnion(taskObj)
  });

  const updatedDoc = await getDoc(collabRef);
  renderAllTasks(updatedDoc.data().tasks || []);

  document.getElementById("newTask").value = "";
  document.getElementById("taskGoal").value = "";
  document.getElementById("taskOrder").value = "";
  document.getElementById("taskDeadline").value = "";
  document.getElementById("taskAssignee").value = "";
  document.getElementById("taskLinks").value = "";
};


      document.getElementById("editCollab").onclick = () => {
        const newTitle = prompt("Edit Title", data.title);
        const newDesc = prompt("Edit Description", data.description);
        updateDoc(collabRef, { title: newTitle, description: newDesc });
      };
    }
  </script>
  <script type="module">
    const footer = await fetch('https://rw-501.github.io/contenthub/includes/footer.html').then(res => res.text());
    document.getElementById('footerContainer').innerHTML = footer;
    import('https://rw-501.github.io/contenthub/includes/footer.js');
  </script>


</body>
</html>
