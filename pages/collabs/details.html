<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Collaboration Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"/>
  <!-- Add this to your <head> -->
<link rel="stylesheet" href="https://rw-501.github.io/contenthub/css/main.css" /></head>
<body>

    
      <div id="toolbarContainer"></div>

  <!-- Your page content here -->

  <!-- Include Bootstrap JS (required for navbar) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inject toolbar -->
  <script type="module">
    const toolbarContainer = document.getElementById("toolbarContainer");
    const html = await fetch('https://rw-501.github.io/contenthub/includes/nav.html').then(res => res.text());
    toolbarContainer.innerHTML = html;
    import('https://rw-501.github.io/contenthub/includes/nav.js');
  </script>


<!-- Main Section -->
  <main id="main">

<div class="container">
    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="history.back()">‚Üê Back</button>
    

    <button class="btn btn-sm btn-outline-secondary mb-3" onclick="history.back()">‚Üê Back</button>
    <div id="collabInfo"></div>
    <div id="progressSection" class="my-3">
      <div class="progress" style="height: 20px;">
        <div id="progressBarFill" class="progress-bar" role="progressbar" style="width: 0%">0% Complete</div>
      </div>
    </div>
    <div id="taskList"></div>
    <div class="text-center mt-4">
      <button id="requestBtn" class="btn btn-primary">ü§ù Request to Join Project</button>
    </div>

  </main>

<!-- Add this at the bottom of <body> -->
<div id="footerContainer"></div>

<script type="module">
  const footer = await fetch('https://rw-501.github.io/contenthub/includes/footer.html').then(res => res.text());
  document.getElementById('footerContainer').innerHTML = footer;
  import('https://rw-501.github.io/contenthub/includes/footer.js');
</script>


  <!-- Firebase + App Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc,deleteDoc,  collection, onSnapshot, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { db, auth, app  } from 'https://rw-501.github.io/contenthub/js/firebase-config.js';

const params = new URLSearchParams(window.location.search);
const collabId = params.get("id");
if (!collabId) {
  document.getElementById("collabInfo").innerHTML = `<div class="alert alert-danger">Invalid collaboration ID.</div>`;
  throw new Error("No collab ID");
}

const collabRef = doc(db, "collaborations", collabId);
let currentUser;

auth.onAuthStateChanged(user => {
  currentUser = user;
  if (user) loadCollab();
});

function loadCollab() {
  onSnapshot(collabRef, snap => {
    if (!snap.exists()) return;
    const data = snap.data();
    renderCollabHeader(data);
    renderAllTasks(data.tasks || []);
    updateProgressBar(data.tasks || []);
  });
}

function renderCollabHeader(data) {
  const html = `
    <h2>${data.title || "Untitled Project"}</h2>
    <p class="text-muted">${data.description || "No description available."}</p>
    ${renderMedia(data.mediaLink)}
    <p><strong>Visibility:</strong> ${data.isPublic ? "Public" : "Private"}</p>
    <p><strong>Participants:</strong> ${(data.participants || []).length}</p>
  `;
  document.getElementById("collabInfo").innerHTML = html;
}




  function renderCollab(id, data) {
  const dateStr = formatTimestamp(data.timestamp);
  const mediaHTML = renderMediaPreview(data.mediaLink);
  const isPinned = data.pinned;
  const isPublic = data.isPublic;
  const participantCount = (data.participants || []).length;
  const totalTasks = (data.tasks || []).length;
  const progress = data.progress || 0;
  const status = data.status || "active";

  const statusBadge = status === "archive"
    ? `<span class="badge bg-secondary">Archived</span>`
    : `<span class="badge bg-success">Active</span>`;

  return `
    <div class="list-group-item ${isPinned ? 'border border-2 border-warning bg-light' : ''}">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <strong>${data.title || "Untitled Project"}</strong>
          ${isPinned ? '<span class="badge bg-warning text-dark ms-2">üìå Pinned</span>' : ''}
          <p class="mb-1">${data.description?.substring(0, 100) || "No description provided."}</p>
          <small class="text-muted">
            üìÖ ${dateStr}
          </small>
        </div>
        <div class="text-end">
          ${statusBadge}
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="openGroupChat('${id}')">
            <i class="bi bi-chat-left-text"></i> View Project
          </button>
          <button class="btn btn-sm btn-link text-decoration-none" data-bs-toggle="collapse" data-bs-target="#collab-details-${id}">
            Details
          </button>
        </div>
      </div>

      <div class="collapse mt-3" id="collab-details-${id}">
        <div class="border-top pt-3">
          <div class="row mb-2 text-muted small">
            <div class="col-md-4">
              üîê <strong>Visibility:</strong> ${isPublic ? "Public" : "Private"}
            </div>
            <div class="col-md-4">
            üë• Participants: ${participantCount}<br>
            </div>
            <div class="col-md-4">
              ‚úÖ <strong>Tasks:</strong> ${totalTasks}
            </div>
            <div class="col-md-4">
              üìà <strong>Progress:</strong>
              <div class="progress" style="height: 10px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: ${progress}%;" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>
          </div>
          <p class="mb-1"><strong>Full Description:</strong> ${data.description || "No description."}</p>
          ${mediaHTML}
        </div>
      </div>
    </div>
  `;
}


document.getElementById("requestBtn").addEventListener("click", async () => {
  if (!currentUser) {
    const authModal = document.getElementById("auth-login");
    authModal?.classList.remove("d-none");
    return;
  }

  const collabRef = doc(db, "collaborations", collabId);
  const docSnap = await getDoc(collabRef);
  const data = docSnap.data();
  const participants = data.participants || [];
  const ownerId = data.owner; // ‚úÖ Make sure this is defined

  if (participants.includes(currentUser.uid)) {
    showModal({
      title: "Info",
      message: "You're already part of this collaboration.",
      autoClose: 3000
    });
    return;
  }

  const avatar = document.getElementById("userAvatar");
  const viewerUserId = avatar?.dataset?.uid;
  const viewerDisplayName = avatar?.dataset?.displayName;
  const viewerRole = avatar?.dataset?.role;
  const viewerUsername = avatar?.dataset?.username;
  const viewerUserPhotoURL = avatar?.dataset?.photo;

  if (ownerId === viewerUserId) {
    alert("‚ö†Ô∏è You are the owner of this post");
    return;
  }

  const requestInfo = {
    uid: viewerUserId,
    displayName: viewerDisplayName || viewerUsername || "Unknown User",
    username: viewerUsername || "",
    photoURL: viewerUserPhotoURL || "https://rw-501.github.io/contenthub/images/defaultAvatar.png",
    role: "viewer",
    status: "pending",
    requestedAt: Timestamp.now()
  };

  try {
    await updateDoc(collabRef, {
      requests: arrayUnion(requestInfo)
    });

    showModal({
      title: "Request Sent",
      message: "Your request to join this collaboration has been submitted.",
      autoClose: 3000
    });
  } catch (error) {
    console.error("Failed to send request:", error);
    showModal({
      title: "Error",
      message: "There was an issue submitting your request. Try again later.",
      autoClose: 3000
    });
  }
});




  </script>
</body>
</html>
